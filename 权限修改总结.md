# 权限体系修改总结

## 📋 修改概述

根据新的权限需求，将原有的四级用户角色简化为三级，并明确了各角色的权限分工：

- **管理员**：系统管理和监督权限
- **环保局人员**：任务创建和交办权限（只能填写第1步）
- **属地所人员**：任务处理和反馈权限（只能填写第2、3步，且只能看到自己属地的任务）

## ✅ 已完成的代码修改

### 1. 用户角色定义更新
- **文件**: `src/views/IssueListView.vue`
- **修改**: 将用户角色从 `'一中队人员' | '负责人' | '管理员' | '属地所人员'` 更新为 `'管理员' | '环保局人员' | '属地所人员'`
- **新增**: 添加了 `area` 字段用于属地所人员的属地信息

### 2. 权限控制逻辑优化
- **文件**: `src/views/IssueListView.vue`
- **修改**: 
  - 更新了 `canCreateIssue` 计算属性，只允许管理员和环保局人员创建问题
  - 在 `fetchIssueList` 方法中增加了属地过滤逻辑
  - 更新了 `getIssueViewRoute` 方法，根据用户角色决定进入哪一步

### 3. 路由权限配置
- **文件**: `src/router/index.js`
- **修改**:
  - 更新了所有路由的 `roles` 配置
  - 第1步：只允许管理员和环保局人员访问
  - 第2、3步：只允许管理员和属地所人员访问
  - 更新了路由守卫，增加了详细的权限验证逻辑

### 4. API接口适配
- **文件**: `src/utils/api.js`
- **修改**:
  - 更新了模拟数据结构，使用 `area` 字段替代 `location`
  - 增加了 `currentStep` 字段标识当前进度
  - 在 `getIssueList` 方法中增加了按属地筛选的功能
  - 更新了数据转换逻辑以适应新的字段结构

## 🔄 业务流程变化

### 环保局人员工作流程
1. 登录系统 → 查看问题列表
2. 新建问题 → 选择表单类型
3. 填写第一步"交办信息" → 选择属地
4. 提交交办 → 任务推送给对应属地所

### 属地所人员工作流程
1. 登录系统 → 查看本属地任务列表
2. 选择待处理任务 → 直接进入第二步
3. 填写第二步"问题交办" → 填写第三步"整改情况"
4. 提交完成

## 🚨 需要后端配合的修改

### 1. 用户信息接口调整
```javascript
// 用户信息需要包含area字段
{
  "id": "1",
  "username": "admin",
  "realName": "张三",
  "role": "属地所人员", // 三选一：管理员、环保局人员、属地所人员
  "area": "开发区", // 属地所人员必须有此字段
  "permissions": ["view", "edit"]
}
```

### 2. 问题列表接口调整
```javascript
// 请求参数增加area过滤
GET /api/issues?page=1&pageSize=10&area=开发区

// 响应数据调整
{
  "list": [{
    "id": "1",
    "name": "问题名称",
    "formType": "督查在线",
    "area": "开发区", // 属地信息
    "currentStep": 2, // 当前步骤
    "status": "待处理", // 状态调整
    "creator": "环保局张三",
    "handler": "属地所李四"
  }]
}
```

### 3. 权限验证逻辑
- 环保局人员：只能创建任务和访问第1步
- 属地所人员：只能访问推送给自己属地的任务，且只能访问第2、3步
- 管理员：拥有所有权限

## 📝 前端代码运行验证

### 测试用户数据
可以在浏览器localStorage中设置不同角色的用户数据进行测试：

```javascript
// 环保局人员
localStorage.setItem('userInfo', JSON.stringify({
  role: '环保局人员',
  username: 'huanbao001',
  realName: '张三',
  area: null
}))

// 属地所人员
localStorage.setItem('userInfo', JSON.stringify({
  role: '属地所人员',
  username: 'shudi001',
  realName: '李四',
  area: '开发区'
}))

// 管理员
localStorage.setItem('userInfo', JSON.stringify({
  role: '管理员',
  username: 'admin',
  realName: '管理员',
  area: null
}))
```

## ⚡ 关键改进点

1. **权限分离更清晰**：环保局负责交办，属地所负责处理
2. **数据隔离更安全**：属地所人员只能看到自己属地的任务
3. **流程控制更严格**：不同角色只能访问对应的步骤
4. **路由守卫更完善**：增加了详细的权限验证和错误处理

## 🎯 后续建议

1. **用户认证**：建议实现完整的登录系统和JWT认证
2. **权限管理**：可以考虑实现更细粒度的权限控制
3. **审计日志**：建议记录用户操作日志，便于追踪
4. **数据校验**：后端需要验证用户是否有权限操作特定任务

---

**注意**：所有修改都已在前端代码中完成，后端团队可以根据此文档进行相应的API开发和权限控制实现。 